<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Text Cleaner & Chunker</title>

  <style>
    body {
      font-family: Roboto, sans-serif;
      background: #f4f7f6;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 25px;
    }
    textarea, input {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      font-size: 15px;
    }
    .btn-paste { background: #6f42c1; }
    .btn-split { background: #28a745; }

    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #charCount {
      text-align: right;
      font-size: 13px;
      color: #555;
      margin-top: 5px;
    }
    .chunk-container {
      margin-top: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 15px;
    }
    .chunk-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .copy-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .copy-button.copied {
      background: #218838;
    }
    .chunk-textarea {
      width: 100%;
      height: 110px;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>Text Cleaner & Chunker</h1>

  <div class="actions">
    <button class="btn btn-paste" id="pasteBtn">Paste & Split</button>
    <button class="btn btn-split" id="splitBtn">Clean & Split</button>
  </div>

  <textarea id="chapterContent" placeholder="Paste text here..."></textarea>
  <div id="charCount">Total characters: 0</div>

  <input type="hidden" id="startMarker">
  <input type="hidden" id="endMarker">
  <input type="hidden" id="useStartRegex">
  <input type="hidden" id="useEndRegex">

  <div id="chunkedTextContainer"></div>
</div>

<script>
  let lastClickedCopyButton = null;

  function updateCharCount() {
    const t = chapterContent.value;
    charCount.textContent = `Total characters: ${t.length}`;
  }

  function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
      if (lastClickedCopyButton && lastClickedCopyButton !== btn) {
        lastClickedCopyButton.classList.remove('copied');
        lastClickedCopyButton.textContent = 'Copy';
      }
      btn.textContent = 'Copied âœ”';
      btn.classList.add('copied');
      lastClickedCopyButton = btn;
    });
  }

  function chunkText() {
    let text = chapterContent.value;

    const startRegex = new RegExp(startMarker.value);
    const endRegex = new RegExp(endMarker.value);

    const startMatch = startRegex.exec(text);
    if (startMatch) text = text.slice(startMatch.index);

    const endMatch = endRegex.exec(text);
    if (endMatch) text = text.slice(0, endMatch.index);

    text = text.trim();
    chapterContent.value = text;
    updateCharCount();

    const maxChars = 1800;
    const lines = text.split('\n');
    let chunks = [];
    let current = '';

    for (const line of lines) {
      const l = line.trim();
      if (!l) continue;

      if (current.length + l.length + 1 > maxChars) {
        chunks.push(current);
        current = '';
      }
      current += (current ? '\n' : '') + l;
    }
    if (current) chunks.push(current);

    chunkedTextContainer.innerHTML = '';
    lastClickedCopyButton = null;

    chunks.forEach((chunk, i) => {
      const box = document.createElement('div');
      box.className = 'chunk-container';

      const header = document.createElement('div');
      header.className = 'chunk-header';

      const title = document.createElement('div');
      title.textContent = `Part ${i + 1} of ${chunks.length}`;

      const btn = document.createElement('button');
      btn.className = 'copy-button';
      btn.textContent = 'Copy';

      const ta = document.createElement('textarea');
      ta.className = 'chunk-textarea';
      ta.value = chunk;

      btn.onclick = () => copyToClipboard(ta.value, btn);

      header.append(title, btn);
      box.append(header, ta);
      chunkedTextContainer.appendChild(box);
    });
  }

  async function pasteAndSplit() {
    try {
      chapterContent.value = await navigator.clipboard.readText();
    } catch {
      const manual = prompt('Paste text here:');
      if (manual !== null) chapterContent.value = manual;
    }
    updateCharCount();
    chunkText();
  }

  document.addEventListener('DOMContentLoaded', () => {
    startMarker.value = 'ç¬¬\\d+ç« [\\s\\S]*';
    endMarker.value = '\\(æœ¬ç« å®Œ\\)';
    useStartRegex.value = '1';
    useEndRegex.value = '1';

    pasteBtn.onclick = pasteAndSplit;
    splitBtn.onclick = chunkText;

    chapterContent.addEventListener('input', updateCharCount);

    chapterContent.addEventListener('paste', () => {
      setTimeout(chunkText, 0);
    });

    // ðŸ”¥ ENTER KEY HANDLER
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chunkText();
      }
    });

    updateCharCount();
  });
</script>
</body>
</html>
